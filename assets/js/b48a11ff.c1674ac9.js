"use strict";(self.webpackChunknour_api_docs=self.webpackChunknour_api_docs||[]).push([[822],{7303:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"database","title":"Database: Getting Started","description":"*   Introduction","source":"@site/docs/database.md","sourceDirName":".","slug":"/database","permalink":"/nour-api/docs/database","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Cache","permalink":"/nour-api/docs/cache"}}');var s=t(4848),i=t(8453);const r={},o="Database: Getting Started",d={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Configuration",id:"configuration",level:2},{value:"SQLite Configuration",id:"sqlite-configuration",level:3},{value:"Read &amp; Write Connections",id:"read--write-connections",level:2},{value:"The <code>sticky</code> Option",id:"the-sticky-option",level:4},{value:"Running Raw SQL Queries",id:"running-raw-sql-queries",level:2},{value:"Running A Select Query",id:"running-a-select-query",level:4},{value:"Using Named Bindings",id:"using-named-bindings",level:4},{value:"Running An Insert Statement",id:"running-an-insert-statement",level:4},{value:"Running An Update Statement",id:"running-an-update-statement",level:4},{value:"Running A Delete Statement",id:"running-a-delete-statement",level:4},{value:"Running A General Statement",id:"running-a-general-statement",level:4},{value:"Database Transactions",id:"database-transactions",level:2},{value:"Handling Deadlocks",id:"handling-deadlocks",level:4},{value:"Manually Using Transactions",id:"manually-using-transactions",level:4}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"database-getting-started",children:"Database: Getting Started"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#introduction",children:"Introduction"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#configuration",children:"Configuration"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#read--write-connections",children:"Read & Write Connections"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#running-raw-sql-queries",children:"Running Raw SQL Queries"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#database-transactions",children:"Database Transactions"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(n.p,{children:["Nour-API makes interacting with databases extremely simple across a variety of database backends using either raw SQL, the ",(0,s.jsx)(n.a,{href:"https://laravel.com/docs/queries",children:"fluent query builder"}),", or the ",(0,s.jsx)(n.a,{href:"https://laravel.com/docs/eloquent",children:"Eloquent ORM"}),". Currently, Nour-API supports four databases:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"MySQL 5.7+"}),"\n",(0,s.jsx)(n.li,{children:"PostgreSQL 9.6+"}),"\n",(0,s.jsx)(n.li,{children:"SQLite 3.8.8+"}),"\n",(0,s.jsx)(n.li,{children:"SQL Server 2017+"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["The database configuration for your application is located in the ",(0,s.jsx)(n.code,{children:"config/database.php"})," file. In this file you may define all of your database connections, as well as specify which connection should be used by default. Examples for most of the supported database systems are provided in this file."]}),"\n",(0,s.jsxs)(n.p,{children:["By default, Nour-API's sample environment configuration is ready to use with ",(0,s.jsx)(n.a,{href:"https://laravel.com/docs/homestead",children:"Laravel Homestead"}),", which provides a convenient virtual machine for doing Laravel development on your local machine. You are free to modify this configuration as needed for your local database."]}),"\n",(0,s.jsx)(n.h3,{id:"sqlite-configuration",children:"SQLite Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["After creating a new SQLite database using a command such as ",(0,s.jsx)(n.code,{children:"touch database/database.sqlite"}),", you can easily configure your environment variables to point to this newly created database by using the database's absolute path:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"DB_CONNECTION=sqlite\nDB_DATABASE=/absolute/path/to/database.sqlite\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To enable foreign key constraints for SQLite connections, you should add the ",(0,s.jsx)(n.code,{children:"foreign_key_constraints"})," option to your ",(0,s.jsx)(n.code,{children:"config/database.php"})," configuration file:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"'sqlite' => [\n    // ...\n    'foreign_key_constraints' => true,\n],\n"})}),"\n",(0,s.jsx)(n.h2,{id:"read--write-connections",children:"Read & Write Connections"}),"\n",(0,s.jsx)(n.p,{children:"Sometimes you may wish to use one database connection for SELECT statements, and another for INSERT, UPDATE, and DELETE statements. Nour-API makes this a breeze, and the proper connections will always be used whether you are using raw queries, the query builder, or the Eloquent ORM."}),"\n",(0,s.jsx)(n.p,{children:"To see how read / write connections should be configured, let's look at this example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"'mysql' => [\n    'read' => [\n        'host' => [\n            '192.168.1.1',\n            '196.168.1.2',\n        ],\n    ],\n    'write' => [\n        'host' => [\n            '196.168.1.3',\n        ],\n    ],\n    'sticky' => true,\n    'driver' => 'mysql',\n    'database' => 'database',\n    'username' => 'root',\n    'password' => '',\n    'charset' => 'utf8mb4',\n    'collation' => 'utf8mb4_unicode_ci',\n    'prefix' => '',\n],\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note that three keys have been added to the configuration array: ",(0,s.jsx)(n.code,{children:"read"}),", ",(0,s.jsx)(n.code,{children:"write"})," and ",(0,s.jsx)(n.code,{children:"sticky"}),". The ",(0,s.jsx)(n.code,{children:"read"})," and ",(0,s.jsx)(n.code,{children:"write"})," keys have array values containing a single key: ",(0,s.jsx)(n.code,{children:"host"}),". The rest of the database options for the ",(0,s.jsx)(n.code,{children:"read"})," and ",(0,s.jsx)(n.code,{children:"write"})," connections will be merged from the main ",(0,s.jsx)(n.code,{children:"mysql"})," array."]}),"\n",(0,s.jsxs)(n.p,{children:["You only need to place items in the ",(0,s.jsx)(n.code,{children:"read"})," and ",(0,s.jsx)(n.code,{children:"write"})," arrays if you wish to override the values from the main array. So, in this case, ",(0,s.jsx)(n.code,{children:"192.168.1.1"})," and ",(0,s.jsx)(n.code,{children:"192.168.1.2"}),' will be used as the host for the "read" connection, while ',(0,s.jsx)(n.code,{children:"192.168.1.3"}),' will be used for the "write" connection. The database credentials, prefix, character set, and all other options in the main ',(0,s.jsx)(n.code,{children:"mysql"})," array will be shared across both connections."]}),"\n",(0,s.jsxs)(n.h4,{id:"the-sticky-option",children:["The ",(0,s.jsx)(n.code,{children:"sticky"})," Option"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"sticky"})," option is an ",(0,s.jsx)(n.em,{children:"optional"})," value that can be used to allow the immediate reading of records that have been written to the database during the current request cycle. If the ",(0,s.jsx)(n.code,{children:"sticky"}),' option is enabled and a "write" operation has been performed against the database during the current request cycle, any further "read" operations will use the "write" connection. This ensures that any data written during the request cycle can be immediately read back from the database during that same request. It is up to you to decide if this is the desired behavior for your application.']}),"\n",(0,s.jsx)(n.h2,{id:"running-raw-sql-queries",children:"Running Raw SQL Queries"}),"\n",(0,s.jsxs)(n.p,{children:["Once you have configured your database connection, you may run queries using the ",(0,s.jsx)(n.code,{children:"DB"})," facade. The ",(0,s.jsx)(n.code,{children:"DB"})," facade provides methods for each type of query: ",(0,s.jsx)(n.code,{children:"select"}),", ",(0,s.jsx)(n.code,{children:"update"}),", ",(0,s.jsx)(n.code,{children:"insert"}),", ",(0,s.jsx)(n.code,{children:"delete"}),", and ",(0,s.jsx)(n.code,{children:"statement"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"running-a-select-query",children:"Running A Select Query"}),"\n",(0,s.jsxs)(n.p,{children:["To run a basic query, you may use the ",(0,s.jsx)(n.code,{children:"select"})," method on the ",(0,s.jsx)(n.code,{children:"DB"})," facade:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Http\\Controllers;\n\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\n\nclass UserController extends Controller\n{\n    /**\n     * Show a list of all of the application's users.\n     *\n     * @return Response\n     */\n    public function index()\n    {\n        $users = DB::select('select * from users where active = ?', [1]);\n\n        return response()->json($users);\n    }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The first argument passed to the ",(0,s.jsx)(n.code,{children:"select"})," method is the raw SQL query, while the second argument is any parameter bindings that need to be bound to the query. Typically, these are the values of the ",(0,s.jsx)(n.code,{children:"where"})," clause constraints. Parameter binding provides protection against SQL injection."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"select"})," method will always return an ",(0,s.jsx)(n.code,{children:"array"})," of results. Each result within the array will be a PHP ",(0,s.jsx)(n.code,{children:"stdClass"})," object, allowing you to access the values of the results:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"foreach ($users as $user) {\n    echo $user->name;\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"using-named-bindings",children:"Using Named Bindings"}),"\n",(0,s.jsxs)(n.p,{children:["Instead of using ",(0,s.jsx)(n.code,{children:"?"})," to represent your parameter bindings, you may execute a query using named bindings:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$results = DB::select('select * from users where id = :id', ['id' => 1]);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"running-an-insert-statement",children:"Running An Insert Statement"}),"\n",(0,s.jsxs)(n.p,{children:["To execute an ",(0,s.jsx)(n.code,{children:"insert"})," statement, you may use the ",(0,s.jsx)(n.code,{children:"insert"})," method on the ",(0,s.jsx)(n.code,{children:"DB"})," facade. Like ",(0,s.jsx)(n.code,{children:"select"}),", this method takes the raw SQL query as its first argument and bindings as its second argument:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"DB::insert('insert into users (id, name) values (?, ?)', [1, 'Dayle']);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"running-an-update-statement",children:"Running An Update Statement"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"update"})," method should be used to update existing records in the database. The number of rows affected by the statement will be returned:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$affected = DB::update('update users set votes = 100 where name = ?', ['John']);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"running-a-delete-statement",children:"Running A Delete Statement"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"delete"})," method should be used to delete records from the database. Like ",(0,s.jsx)(n.code,{children:"update"}),", the number of rows affected will be returned:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$deleted = DB::delete('delete from users');\n"})}),"\n",(0,s.jsx)(n.h4,{id:"running-a-general-statement",children:"Running A General Statement"}),"\n",(0,s.jsxs)(n.p,{children:["Some database statements do not return any value. For these types of operations, you may use the ",(0,s.jsx)(n.code,{children:"statement"})," method on the ",(0,s.jsx)(n.code,{children:"DB"})," facade:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"DB::statement('drop table users');\n"})}),"\n",(0,s.jsx)(n.h2,{id:"database-transactions",children:"Database Transactions"}),"\n",(0,s.jsxs)(n.p,{children:["You may use the ",(0,s.jsx)(n.code,{children:"transaction"})," method on the ",(0,s.jsx)(n.code,{children:"DB"})," facade to run a set of operations within a database transaction. If an exception is thrown within the transaction ",(0,s.jsx)(n.code,{children:"Closure"}),", the transaction will automatically be rolled back. If the ",(0,s.jsx)(n.code,{children:"Closure"})," executes successfully, the transaction will automatically be committed. You don't need to worry about manually rolling back or committing while using the ",(0,s.jsx)(n.code,{children:"transaction"})," method:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"DB::transaction(function () {\n    DB::table('users')->update(['votes' => 1]);\n\n    DB::table('posts')->delete();\n});\n"})}),"\n",(0,s.jsx)(n.h4,{id:"handling-deadlocks",children:"Handling Deadlocks"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"transaction"})," method accepts an optional second argument which defines the number of times a transaction should be reattempted when a deadlock occurs. Once these attempts have been exhausted, an exception will be thrown:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"DB::transaction(function () {\n    DB::table('users')->update(['votes' => 1]);\n\n    DB::table('posts')->delete();\n}, 5);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"manually-using-transactions",children:"Manually Using Transactions"}),"\n",(0,s.jsxs)(n.p,{children:["If you would like to begin a transaction manually and have complete control over rollbacks and commits, you may use the ",(0,s.jsx)(n.code,{children:"beginTransaction"})," method on the ",(0,s.jsx)(n.code,{children:"DB"})," facade:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"DB::beginTransaction();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can rollback the transaction via the ",(0,s.jsx)(n.code,{children:"rollBack"})," method:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"DB::rollBack();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Lastly, you can commit a transaction via the ",(0,s.jsx)(n.code,{children:"commit"})," method:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"DB::commit();\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," The ",(0,s.jsx)(n.code,{children:"DB"})," facade's transaction methods control the transactions for both the ",(0,s.jsx)(n.a,{href:"https://laravel.com/docs/queries",children:"query builder"})," and ",(0,s.jsx)(n.a,{href:"https://laravel.com/docs/eloquent",children:"Eloquent ORM"}),"."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var a=t(6540);const s={},i=a.createContext(s);function r(e){const n=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);